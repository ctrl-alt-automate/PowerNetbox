name: Release

on:
  release:
    types: [published]

jobs:
  test:
    name: Pre-release Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module Pester -Force -Scope CurrentUser -MinimumVersion 5.0.0
          Install-Module PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Build module (production)
        shell: pwsh
        run: |
          ./deploy.ps1 -Environment prod -SkipVersion

      - name: Run Pester tests
        shell: pwsh
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = './Tests'
          $config.Run.Exit = $true
          $config.Output.Verbosity = 'Detailed'

          Invoke-Pester -Configuration $config

  publish:
    name: Publish to PSGallery
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Build module (production)
        shell: pwsh
        run: |
          ./deploy.ps1 -Environment prod -SkipVersion

      - name: Validate module manifest
        shell: pwsh
        run: |
          $manifest = Test-ModuleManifest -Path './PowerNetbox/PowerNetbox.psd1'
          Write-Host "Module: $($manifest.Name)"
          Write-Host "Version: $($manifest.Version)"
          Write-Host "Functions: $($manifest.ExportedFunctions.Count)"

      - name: Publish to PowerShell Gallery
        shell: pwsh
        env:
          PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          if ([string]::IsNullOrEmpty($env:PSGALLERY_API_KEY)) {
              Write-Error "PSGALLERY_API_KEY secret is not set!"
              exit 1
          }

          Write-Host "Publishing module to PowerShell Gallery..." -ForegroundColor Cyan
          Publish-Module -Path './PowerNetbox' -NuGetApiKey $env:PSGALLERY_API_KEY -Verbose

          Write-Host "âœ… Successfully published to PowerShell Gallery!" -ForegroundColor Green
