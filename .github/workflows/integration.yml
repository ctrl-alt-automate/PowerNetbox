# Integration Tests
# =================
# Test PowerNetbox against real Netbox instances via Docker
#
# This workflow:
# - Spins up Netbox via Docker Compose
# - Runs integration tests against the live API
# - Tests multiple Netbox versions in parallel (matrix)
# - Only runs on ubuntu (Docker required)
#
# Triggers:
# - Push to dev/main/beta branches
# - Pull requests to dev/main
# - Manual dispatch with custom Netbox version
# - Weekly scheduled run (catch upstream changes)

name: Integration Tests

on:
  push:
    branches: [dev, main, beta]
  pull_request:
    branches: [dev, main]
  # Allow manual trigger with custom version
  workflow_dispatch:
    inputs:
      netbox_version:
        description: 'Netbox Docker image tag (e.g., v4.4.9-3.4.2)'
        required: false
        default: 'v4.4.9-3.4.2'
        type: string
  # Run weekly to catch upstream Netbox changes
  schedule:
    - cron: '0 6 * * 1'  # Every Monday at 6 AM UTC

env:
  # Default API token (matches docker-compose.ci.yml)
  NETBOX_TOKEN: "0123456789abcdef0123456789abcdef01234567"
  # Docker Compose project name (for predictable container names)
  COMPOSE_PROJECT_NAME: "powernetbox"

jobs:
  # ============================================================
  # Integration Tests - Matrix of Netbox versions
  # ============================================================
  integration:
    name: Netbox ${{ matrix.netbox_short }}
    runs-on: ubuntu-latest

    # Don't fail entire workflow if experimental version fails
    continue-on-error: ${{ matrix.experimental }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # ----------------------------------------------------------
          # Minimum supported version
          # ----------------------------------------------------------
          - netbox: "v4.3.7-3.3.0"
            netbox_short: "4.3.7"
            experimental: false

          # ----------------------------------------------------------
          # Stable version - MUST pass (production target)
          # ----------------------------------------------------------
          - netbox: "v4.4.9-3.4.2"
            netbox_short: "4.4.9"
            experimental: false

          # ----------------------------------------------------------
          # Beta/Next version - Allowed to fail
          # ----------------------------------------------------------
          - netbox: "v4.5.0-beta1-3.4.2"
            netbox_short: "4.5.0-beta1"
            experimental: true

    env:
      NETBOX_VERSION: ${{ github.event.inputs.netbox_version || matrix.netbox }}
      NETBOX_HOST: "localhost:8000"

    steps:
      # ----------------------------------------------------------
      # Setup
      # ----------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ----------------------------------------------------------
      # Start Netbox Stack
      # ----------------------------------------------------------
      - name: Pull Docker images
        run: |
          echo "Pulling images for Netbox ${{ env.NETBOX_VERSION }}..."
          docker compose -f docker-compose.ci.yml pull

      - name: Start Netbox stack
        run: |
          echo "Starting Netbox stack..."
          docker compose -f docker-compose.ci.yml up -d

          echo ""
          echo "Container status:"
          docker compose -f docker-compose.ci.yml ps

      - name: Wait for Netbox to be ready
        run: |
          echo "Waiting for Netbox to be ready (this may take 2-3 minutes for first-time setup)..."
          echo ""

          MAX_WAIT=300  # 5 minutes max
          ELAPSED=0
          INTERVAL=10

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            # Check container health status
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' powernetbox-netbox-1 2>/dev/null || echo "starting")

            echo "[${ELAPSED}s] Netbox container status: $STATUS"

            if [ "$STATUS" = "healthy" ]; then
              echo ""
              echo "Netbox is healthy! Verifying web server..."

              # Double-check web server is responding (use /login/ - no auth required)
              if curl -sf http://localhost:8000/login/ > /dev/null 2>&1; then
                echo "Netbox web server is responding!"
                exit 0
              fi
            fi

            if [ "$STATUS" = "unhealthy" ]; then
              echo ""
              echo "ERROR: Container became unhealthy!"
              echo ""
              echo "=== Container Logs ==="
              docker compose -f docker-compose.ci.yml logs netbox --tail 100
              exit 1
            fi

            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

          echo ""
          echo "ERROR: Timeout waiting for Netbox to be ready after ${MAX_WAIT}s"
          echo ""
          echo "=== Container Status ==="
          docker compose -f docker-compose.ci.yml ps
          echo ""
          echo "=== Netbox Logs ==="
          docker compose -f docker-compose.ci.yml logs netbox --tail 100
          exit 1

      - name: Display Netbox version info
        run: |
          echo "=== Netbox Status API ==="
          curl -s http://localhost:8000/api/status/ | jq .

          # Extract version for later use
          VERSION=$(curl -s http://localhost:8000/api/status/ | jq -r '.["netbox-version"]')
          echo ""
          echo "Running Netbox version: $VERSION"
          echo "NETBOX_RUNNING_VERSION=$VERSION" >> $GITHUB_ENV

      # ----------------------------------------------------------
      # Install PowerShell & Dependencies
      # ----------------------------------------------------------
      - name: Install PowerShell dependencies
        shell: pwsh
        run: |
          Write-Host "Installing Pester..." -ForegroundColor Cyan
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module Pester -Force -Scope CurrentUser -MinimumVersion 5.0.0

          $pesterVersion = (Get-Module Pester -ListAvailable | Select-Object -First 1).Version
          Write-Host "Pester version: $pesterVersion" -ForegroundColor Green

      - name: Build PowerNetbox module
        shell: pwsh
        run: |
          Write-Host "Building module..." -ForegroundColor Cyan
          ./deploy.ps1 -Environment dev -SkipVersion

          Write-Host "Importing module..." -ForegroundColor Cyan
          Import-Module ./PowerNetbox/PowerNetbox.psd1 -Force

          $cmdCount = (Get-Command -Module PowerNetbox).Count
          Write-Host "Module loaded with $cmdCount commands" -ForegroundColor Green

      # ----------------------------------------------------------
      # v2 Token Tests (Netbox 4.5+)
      # ----------------------------------------------------------
      - name: Test v2 token format support
        if: startsWith(matrix.netbox_short, '4.5')
        shell: pwsh
        env:
          NETBOX_HOST: ${{ env.NETBOX_HOST }}
          NETBOX_TOKEN: ${{ env.NETBOX_TOKEN }}
        run: |
          Write-Host "============================================" -ForegroundColor Cyan
          Write-Host " Testing v2 Token Support (Netbox 4.5+)" -ForegroundColor Cyan
          Write-Host "============================================" -ForegroundColor Cyan
          Write-Host ""

          Import-Module ./PowerNetbox/PowerNetbox.psd1 -Force

          # Test 1: Bearer header should work on 4.5+
          Write-Host "Test 1: Testing Bearer header authentication..." -ForegroundColor Yellow
          $headers = @{
            'Authorization' = "Bearer $env:NETBOX_TOKEN"
            'Accept' = 'application/json'
          }
          try {
            $response = Invoke-RestMethod -Uri "http://$env:NETBOX_HOST/api/status/" -Headers $headers
            Write-Host "  PASS: Bearer header works on Netbox 4.5+" -ForegroundColor Green
            Write-Host "  Version: $($response.'netbox-version')" -ForegroundColor Gray
          } catch {
            Write-Host "  FAIL: Bearer header failed: $($_.Exception.Message)" -ForegroundColor Red
            exit 1
          }

          # Test 2: Token header should also work (backwards compat)
          Write-Host "Test 2: Testing Token header (backwards compat)..." -ForegroundColor Yellow
          $headers = @{
            'Authorization' = "Token $env:NETBOX_TOKEN"
            'Accept' = 'application/json'
          }
          try {
            $response = Invoke-RestMethod -Uri "http://$env:NETBOX_HOST/api/status/" -Headers $headers
            Write-Host "  PASS: Token header works on Netbox 4.5+" -ForegroundColor Green
          } catch {
            Write-Host "  FAIL: Token header failed: $($_.Exception.Message)" -ForegroundColor Red
            exit 1
          }

          # Test 3: v2 token format detection
          Write-Host "Test 3: Testing v2 token format detection..." -ForegroundColor Yellow
          $v2Token = "nbt_kVJSfSxl3xvO.b4KIab8fc0sKntsws0KK7j6VwWNYnztZ9BOC7NAq"
          $v1Token = "0123456789abcdef0123456789abcdef01234567"

          # v2 token format: nbt_<KEY>.<SECRET>
          $v2Pattern = '^nbt_[A-Za-z0-9]+\.[A-Za-z0-9]+$'
          if ($v2Token -match $v2Pattern) {
            Write-Host "  PASS: v2 token format correctly identified" -ForegroundColor Green
          } else {
            Write-Host "  FAIL: v2 token format not recognized" -ForegroundColor Red
            exit 1
          }

          if ($v1Token -notmatch $v2Pattern) {
            Write-Host "  PASS: v1 token correctly not matched as v2" -ForegroundColor Green
          } else {
            Write-Host "  FAIL: v1 token incorrectly matched as v2" -ForegroundColor Red
            exit 1
          }

          Write-Host ""
          Write-Host "All v2 token tests passed!" -ForegroundColor Green

      # ----------------------------------------------------------
      # Run Integration Tests
      # ----------------------------------------------------------
      - name: Run Integration tests
        id: integration_tests
        shell: pwsh
        env:
          NETBOX_HOST: ${{ env.NETBOX_HOST }}
          NETBOX_TOKEN: ${{ env.NETBOX_TOKEN }}
          NETBOX_VERSION: ${{ matrix.netbox_short }}
        run: |
          Write-Host "============================================" -ForegroundColor Cyan
          Write-Host " Running Integration Tests" -ForegroundColor Cyan
          Write-Host " Netbox: $env:NETBOX_VERSION" -ForegroundColor Cyan
          Write-Host " Host:   $env:NETBOX_HOST" -ForegroundColor Cyan
          Write-Host "============================================" -ForegroundColor Cyan
          Write-Host ""

          $config = New-PesterConfiguration
          $config.Run.Path = './Tests/Integration.Tests.ps1'
          $config.Run.Exit = $true
          $config.Filter.Tag = @('Integration')
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = 'IntegrationTestResults.xml'
          $config.TestResult.OutputFormat = 'NUnitXml'
          $config.Output.Verbosity = 'Detailed'

          Invoke-Pester -Configuration $config

      # ----------------------------------------------------------
      # Artifacts & Cleanup
      # ----------------------------------------------------------
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-results-${{ matrix.netbox_short }}
          path: IntegrationTestResults.xml
          retention-days: 30

      - name: Collect debug logs on failure
        if: failure()
        run: |
          echo "=== Collecting debug information ===" > debug-logs.txt
          echo "" >> debug-logs.txt

          echo "=== Docker Compose Status ===" >> debug-logs.txt
          docker compose -f docker-compose.ci.yml ps >> debug-logs.txt 2>&1
          echo "" >> debug-logs.txt

          echo "=== Netbox Logs (last 200 lines) ===" >> debug-logs.txt
          docker compose -f docker-compose.ci.yml logs netbox --tail 200 >> debug-logs.txt 2>&1
          echo "" >> debug-logs.txt

          echo "=== PostgreSQL Logs ===" >> debug-logs.txt
          docker compose -f docker-compose.ci.yml logs postgres --tail 50 >> debug-logs.txt 2>&1
          echo "" >> debug-logs.txt

          echo "=== Redis Logs ===" >> debug-logs.txt
          docker compose -f docker-compose.ci.yml logs redis --tail 50 >> debug-logs.txt 2>&1

      - name: Upload debug logs on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: debug-logs-${{ matrix.netbox_short }}
          path: debug-logs.txt
          retention-days: 7

      - name: Cleanup Docker resources
        if: always()
        run: |
          echo "Stopping containers..."
          docker compose -f docker-compose.ci.yml down -v --remove-orphans

          echo "Pruning unused Docker resources..."
          docker system prune -f --volumes

  # ============================================================
  # Summary Job - Report overall status
  # ============================================================
  summary:
    name: Integration Summary
    runs-on: ubuntu-latest
    needs: integration
    if: always()

    steps:
      - name: Check integration results
        run: |
          echo "Integration test result: ${{ needs.integration.result }}"

          if [ "${{ needs.integration.result }}" = "failure" ]; then
            echo "::error::One or more integration tests failed!"
            exit 1
          elif [ "${{ needs.integration.result }}" = "cancelled" ]; then
            echo "::warning::Integration tests were cancelled"
            exit 0
          else
            echo "::notice::All integration tests passed!"
          fi
